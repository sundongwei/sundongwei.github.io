---
title: 'ğŸ‰ å®‰è£…DeepStream'
date: 2024-10-28
permalink: /posts/2012/08/blog-post-4/
tags:
  - Academic
  - Technology
  - AI
---

ğŸ‰ğŸ‰ å®‰è£…DeepStream
----

### å®‰è£…ä¾èµ–

```Shell
$ sudo apt install libjson-glib-dev libjansson4 libvtk6-dev python-vtk6 openssl libssl-dev ffmpeg libx11-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-doc gstreamer1.0-tools gstreamer1.0-x gstreamer1.0-alsa gstreamer1.0-gl gstreamer1.0-gtk3 gstreamer1.0-qt5 gstreamer1.0-pulseaudio gstreamer1.0-rtsp libgstreamer-plugins-base1.0-dev libgstreamer1.0-0 libgstreamer1.0-dev libgstrtspserver-1.0-0 libgstrtspserver-1.0-dev 
```

```Shell
sudo apt-get install libv4l-dev
cd /usr/include/linux
sudo ln -s ../libv4l1-videodev.h videodev.h
```

---

### æå‰ä¸‹å¥½deepstream

ä¸‹è½½åœ°å€ï¼š[https://developer.nvidia.com/deepstream-getting-started](https://developer.nvidia.com/deepstream-getting-started)

```Shell
sudo tar -zxvf deepstream_sdk_v6.0.0_x86_64.tbz2 -C /
```

---

### å‘½ä»¤è¡Œå®‰è£…gcc

```Shell
sudo apt-get install build-essential
```

### æºç ç¼–è¯‘å®‰è£…gcc

ä¸‹è½½åœ°å€ï¼š[http://mirrors.nju.edu.cn/gnu/gcc/gcc-7.5.0/](http://mirrors.nju.edu.cn/gnu/gcc/gcc-7.5.0/)

#### å®‰è£…ä¾èµ–ï¼š

ä¸‹è½½å…¶ä»–ä¾èµ–æ–‡ä»¶ï¼Œä»è¿™ä¸ªåœ°å€éƒ½èƒ½æ‰¾åˆ°:[http://www.mirrorservice.org/sites/sourceware.org/pub/gcc/infrastructure/](http://www.mirrorservice.org/sites/sourceware.org/pub/gcc/infrastructure/)

- gmp-6.1.0.tar.bz2

- mpfr-3.1.4.tar.bz2

- mpc-1.0.3.tar.gz

- isl-0.16.1.tar.bz2
æ¯ä¸ªä¾èµ–éƒ½ä½¿ç”¨ç›¸åŒçš„å®‰è£…æ­¥éª¤ï¼Œå¦‚ä¸‹ï¼š

```Shell
./configure
make -j2
sudo make install
```

#### ç¼–è¯‘å®‰è£…gcc

```Shell
ç¼–è¯‘å®‰è£…gcc
./configure --enable-checking=release --enable-languages=c,c++ --disable-multilib
make -j128
sudo make install

å¦‚æœå‡ºç°gccå’Œg++ç‰ˆæœ¬ä¸ä¸€è‡´çš„é—®é¢˜,å¾ˆå¯èƒ½æ˜¯é…ç½®çš„é—®é¢˜,å› ä¸ºç›®å‰ç³»ç»Ÿé‡Œæœ‰å¤šä¸ªgccäº†,è°ƒç”¨å¦‚ä¸‹å‘½ä»¤,å³å¯è§£å†³
/usr/local/bin/gccæ˜¯æˆ‘çš„å®‰è£…è·¯å¾„

sudo update-alternatives --install /usr/bin/gcc gcc /usr/local/bin/gcc  100
sudo update-alternatives --install /usr/bin/gcc gcc /usr/local/bin/g++  100
```

---

### å®‰è£…Cmake

ä¸‹è½½åœ°å€ï¼š[https://cmake.org/files/](https://cmake.org/files/)

```Shell
tar -xvf cmake-3.14.5.tar
cd cmake-3.14.5
./bootstrap 
make
make install
```

---

### TensorRT-8.0.1.6

ä¸‹è½½åœ°å€ï¼š[https://developer.nvidia.com/nvidia-tensorrt-download](https://developer.nvidia.com/nvidia-tensorrt-download)

#### å®‰è£…pycuda

```Shell
# ç¬¬ä¸€ç§æ–¹å¼ æ‰‹åŠ¨ä¸‹è½½å®‰è£…<https://www.lfd.uci.edu/~gohlke/pythonlibs/#pycuda>
pip install {pycuda}.whl
# ç¬¬äºŒç§æ–¹å¼ ç›´æ¥pip
pip install pycuda==2021.1
```

#### å®‰è£…tensorrt

```Shell
#åœ¨homeä¸‹æ–°å»ºæ–‡ä»¶å¤¹ï¼Œå‘½åä¸ºtensorrt_tarï¼Œç„¶åå°†ä¸‹è½½çš„å‹ç¼©æ–‡ä»¶æ‹·è´è¿›æ¥è§£å‹
tar xzvf TensorRT-8.0.1.6.Linux.x86_64-gnu.cuda-11.3.cudnn8.2.tar.gz
 
#è§£å‹å¾—åˆ°TensorRT-8.0.1.6çš„æ–‡ä»¶å¤¹ï¼Œå°†é‡Œè¾¹çš„libå’Œincludeæ·»åŠ éƒ½ç³»ç»Ÿæœç´¢è·¯å¾„ä¸­
mv TensorRT-8.0.1.6/ /usr/local/
mkdir /usr/lib/TensorRT-8.0.1.6
mkdir /usr/include/TensorRT-8.0.1.6
sudo ln -s /usr/local/TensorRT-8.0.1.6/lib /usr/lib/TensorRT-8.0.1.6/lib
sudo ln -s /usr/local/TensorRT-8.0.1.6/include /usr/include/TensorRT-8.0.1.6/include

# å®‰è£…TensorRT python API
cd /usr/local/TensorRT-8.0.1.6/python
pip install tensorrt-8.0.1.6-py2.py3-none-any.whl
 
# å®‰è£…UFF,æ”¯æŒtensorflowæ¨¡å‹è½¬åŒ–
cd TensorRT-8.0.1.6/uff
pip install uff-0.5.5-py2.py3-none-any.whl
 
# å®‰è£…graphsurgeonï¼Œæ”¯æŒè‡ªå®šä¹‰ç»“æ„
cd TensorRT-8.0.1.6/graphsurgeon
pip install graphsurgeon-0.3.2-py2.py3-none-any.whl

#é…ç½®
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/sdw/TensorRT-8.4.3.1/lib
```

---

### å®‰è£…librdkafka

```Shell
git clone https://github.com/edenhill/librdkafka.git
cd librdkafka
git reset --hard 7101c2310341ab3f4675fc565f64f0967e135a6a
./configure
make
sudo make install
sudo cp /usr/local/lib/librdkafka* /opt/nvidia/deepstream/deepstream-6.0/lib
```

---

### æºç ç¼–è¯‘GPUç‰ˆOpenCV

** ä½¿ç”¨æºç å®‰è£…opencvï¼Œæ³¨æ„è¦å¸¦cudaå’Œgstreamerï¼Œè¿™ä¸€æ­¥å®¹æ˜“å‡ºç°é—®é¢˜ï¼Œå°†ä¸€äº›å…³é”®æ­¥éª¤åšäº›è¯´æ˜ï¼ŒæŒ‰ç…§ä¸‹è¾¹æŒ‡ä»¤å®‰è£… **

#### å®‰è£…ä¾èµ–

```Shell
sudo apt-get install libavcodec-dev libavformat-dev libavdevice-dev ffmpeg
```

#### ç¼–è¯‘OpenCV

```Shell
wget https://github.com/opencv/opencv/archive/3.4.0.zip -O opencv-3.4.0.zip
unzip opencv-3.4.0.zip
cd opencv-3.4.0
wget https://github.com/opencv/opencv_contrib/archive/3.4.0.zip -O opencv_contrib-3.4.0.zip
unzip opencv_contrib-3.4.0.zip 
mkdir build && cd build

cmake -D CMAKE_BUILD_TYPE=Release -D CMAKE_INSTALL_PREFIX=/usr -D BUILD_PNG=OFF -D BUILD_TIFF=OFF -D BUILD_TBB=OFF -D BUILD_JPEG=OFF Â -D BUILD_JASPER=OFF -D BUILD_ZLIB=OFF -D BUILD_EXAMPLES=OFF -D BUILD_opencv_java=OFF -D BUILD_opencv_python2=ON -D BUILD_opencv_python3=ON -D ENABLE_PRECOMPILED_HEADERS=OFF -D WITH_OPENCL=OFF -D WITH_OPENMP=OFF -D WITH_FFMPEG=ON -D WITH_GSTREAMER=ON -D WITH_CUDA=ON -D WITH_GTK=ON -D WITH_VTK=ON -D WITH_TBB=ON -D WITH_1394=OFF -D WITH_OPENEXR=OFF -D OPENCV_EXTRA_MODULES_PATH=/opt/opencv-3.4.0/opencv_contrib-3.4.0/modules Â -D CUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda -D CUDA_ARCH_BIN=7.5 -D INSTALL_C_EXAMPLES=ONÂ -D INSTALL_TESTS=OFF ..

make -j128
sudo make install
```

æŸ¥çœ‹æ˜¾å¡CUDA_ARCH_BIN

[https://developer.nvidia.com/zh-cn/cuda-gpus#compute](https://developer.nvidia.com/zh-cn/cuda-gpus#compute)

- æ–¹æ³•1ï¼šåˆ©ç”¨cuda_sampleæŸ¥çœ‹

```Shell

cd /usr/local/cuda/samples/1_Utilities/deviceQuery
sudo make
./deviceQuery
```

è¾“å‡ºå…¶ä¸­çš„** CUDA Capability Major/Minor version number:    7.5 **

- æ–¹æ³•2ï¼šgitä¸‹è½½ä»£ç ç¼–è¯‘

```Shell
git clone https://github.com/NVIDIA-AI-IOT/deepstream_tlt_apps.git
cd deepstream_tlt_apps/TRT-OSS/x86
nvcc deviceQuery.cpp -o deviceQuery
./deviceQuery
```

#### æ£€æµ‹ç‰ˆæœ¬

```Shell
pkg-config --modversion opencv
pkg-config --cflags --libs opencv
# or
python
import cv2
cv2.getBuildInformation()
```

#### å®‰è£…ç¼–è¯‘å¥½çš„opencv pythonåº“

```Shell
cd opencv-3.4.0/build/python_loader/
python setup.py install
```

#### å¯èƒ½çš„æŠ¥é”™

```Plain Text
1.æ‰¾ä¸åˆ°gst/gstxxx.hppé—®é¢˜
åœ¨/usr/includeä¸‹æ–°å»ºè½¯è¿æ¥
$ cd /usr/include
$ sudo ln -s gstreamer-1.0/gst/ gst

2.dynlink_nvcuvid.hé—®é¢˜
cuda10ä¸å†æä¾›dynlink_nvcuvid.håŠŸèƒ½ï¼Œä¿®æ”¹opencv-3.4.0/modules/cudacodec/srcç›®å½•ä¸‹çš„æ–‡ä»¶

modules/cudacodec/src/precomp.hpp
modules/cudacodec/src/video_decoder.hpp
modules/cudacodec/src/video_parser.hpp
modules/cudacodec/src/cuvid_video_source.hpp
modules/cudacodec/src/frame_queue.hpp
æ‰¾åˆ°ä¸‹è¾¹çš„ä»£ç 

#if CUDA_VERSION >= 9000
#include <dynlink_nvcuvid.h>
#else
#include <nvcuvid.h>
#endif
æ›¿æ¢ä¸º

#if CUDA_VERSION >= 9000 && CUDA_VERSION < 10000
#include <dynlink_nvcuvid.h>
#else
#include <nvcuvid.h>
#endif
å¦‚æœæ”¹å®Œè¿˜æŠ¥é”™çš„è¯ï¼Œéœ€è¦ä¸‹è½½Â nvidia-sdkï¼Œä¸‹è½½é“¾æ¥ï¼šhttps://developer.nvidia.com/designworks/video_codec_sdk/downloads/v9.0

ä¸‹è½½è§£å‹åå°†å…¶ä¸­çš„ nvcuvid.h, cuviddec.h copy åˆ° /usr/local/cuda/include

ç„¶åé‡æ–°makeå³å¯ 

3.ippicv_2017u3_lnx_intel64_general_20170822.tgzä¸‹è½½æ…¢é—®é¢˜
https://github.com/opencv/opencv_3rdparty/tree/ippicv/master_20170822/ippicv
æŸ¥çœ‹buildç›®å½•ä¸‹çš„CmakeDownloadLog.txtï¼Œé‡Œè¾¹è®°å½•äº†ä¸‹è½½åœ°å€ï¼Œæˆ‘è¿™é‡Œçš„è·¯å¾„æ˜¯

use_cache "/home/nvidia/opencv_3.4.0/opencv-3.4.0/.cache"
do_unpack "ippicv_2017u3_lnx_intel64_general_20170822.tgz" "4e0352ce96473837b1d671ce87f17359" "https://raw.githubusercontent.com/opencv/opencv_3rdparty/dfe3162c237af211e98b8960018b564bc209261d/ippicv/ippicv_2017u3_lnx_intel64_general_20170822.tgz" "/home/nvidia/opencv_3.4.0/opencv-3.4.0/build/3rdparty/ippicv"
#check_md5 "/home/nvidia/opencv_3.4.0/opencv-3.4.0/.cache/ippicv/4e0352ce96473837b1d671ce87f17359-ippicv_2017u3_lnx_intel64_general_20170822.tgz"

å¯ä»¥çœ‹åˆ°æ˜¯æŠŠè¿™ä¸ªæ–‡ä»¶ä¸‹è½½åˆ°/home/nvidia/opencv_3.3.1/opencv-3.3.1/.cache/ippicv/ä¸‹ï¼Œå¹¶å‘½åä¸º4e0352ce96473837b1d671ce87f17359-ippicv_2017u3_lnx_intel64_general_20170822.tgzï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ‰‹åŠ¨ä¸‹è½½çš„æ–‡ä»¶ç„¶åå¤åˆ¶åˆ°è¯¥è·¯å¾„ä¸‹å³å¯

4 cblas_xxxé—®é¢˜
å¦‚æœå‡ºç°ç¼–è¯‘é—®é¢˜â€œundefined reference to `cblas_sgemm(CBLAS_ORDER, CBLAS_TRANSPOSE, CBLAS_TRANSPOSE, int, int, int, float, float const, int, float const, int, float, float*, int)'â€

å¯èƒ½éœ€è¦é‡æ–°ç¼–è¯‘BLASï¼ŒCBLASï¼ŒLPACKï¼Œå‚è€ƒé“¾æ¥ã€Šblasã€lapackã€cblasåœ¨Ubuntuä¸Šçš„å®‰è£…ã€‹<https://www.jianshu.com/p/33c4aea6117b>

5Â boostdesc_bgm.iç­‰é—®é¢˜
åœ¨opencv_contribç›®å½•ä¸­æŠ¥é”™fatal error: boostdesc_bgm.i: No such file or directory

è¿™ä¸ªè·Ÿ2.4.2ç±»ä¼¼ï¼Œæ˜¯æœ‰äº›åŒ…ä¸‹è½½ä¸æˆåŠŸå¯¼è‡´çš„ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½https://github.com/nanmi/myresource/tree/main/opencv_3rdparts/ä¸‹é¢çš„èµ„æºï¼Œå‚è€ƒé“¾æ¥ï¼š<https://github.com/opencv/opencv_contrib/issues/1301>ï¼Œç„¶åæ‹·è´åˆ°opencv_contrib/modules/xfeatures2d/src/Â è·¯å¾„ä¸‹ï¼Œé‡æ–°ç¼–è¯‘å³å¯

6 å¤šç‰ˆæœ¬é—®é¢˜
å¦‚æœä¹‹å‰å®‰è£…è¿‡å…¶å®ƒç‰ˆæœ¬æ²¡æœ‰å¸è½½ï¼Œå¯ä»¥é‡‡ç”¨ã€ŠUbuntuä¸‹å¤šä¸ªç‰ˆæœ¬OpenCVç®¡ç†ï¼ˆMultiple Opencv versionï¼‰ã€‹æ¥æŒ‡å®šç¼–è¯‘æ—¶ç”¨åˆ°çš„opencvç‰ˆæœ¬ï¼Œè¿æ¥ï¼š<https://www.cnblogs.com/cmt/p/14580194.html?from=https%3A%2F%2Fwww.cnblogs.com%2Fxzd1575%2Fp%2F5555523.html>

7Â opencv2/xfeatures2d/cuda.hppé—®é¢˜
ä¿®æ”¹/opencv-3.4.0/modules/stitching/CMakeLists.txtæ–‡ä»¶ï¼Œåœ¨å¼€å¤´å¢åŠ ä¸‹è¾¹å†…å®¹ï¼Œç„¶åé‡æ–°cmakeå’Œmake

INCLUDE_DIRECTORIES("/<your location>/opencv_contrib-3.4.0/modules/xfeatures2d/include")Â 

å¦‚æœä¿®æ”¹åè¿˜æŠ¥é”™ï¼Œåˆ™æ‰¾åˆ°æŠ¥é”™çš„æ–‡ä»¶ï¼Œå°†å¤´æ–‡ä»¶æ”¹æˆç»å¯¹è·¯å¾„Â 

8 "xxxx/test_detectors_invariance.impl.hpp"é—®é¢˜
ä¸€èˆ¬æ˜¯è¯´åœ¨features2d/testç›®å½•ä¸‹æ²¡æœ‰XXX.hppä»€ä¹ˆçš„ï¼Œå¤„ç†æ–¹å¼æ˜¯å°†opencv-3.3.1/modules/features2d/testè¯¥ç›®å½•ä¸‹å¯¹äºçš„ç¼ºå°‘æ–‡ä»¶å¤åˆ¶åˆ°opencv_contrib-3.3.1/modules/xfeatures2d/testè¯¥ç›®å½•ä¸‹ï¼Œç„¶åä¿®æ”¹æŠ¥é”™çš„æ–‡ä»¶çš„#includeï¼Œå°†å‰é¢çš„åœ°å€åˆ é™¤ï¼Œå°±è®©å…¶åœ¨æœ¬åœ°æ‰¾

ä¾‹å¦‚ :æŠ¥é”™è¯´åœ¨æ–‡ä»¶test_rotation_and_scale_invariance.cppä¸­æ‰¾ä¸åˆ°#include "xxxx/test_detectors_invariance.impl.hpp"ï¼Œé‚£ä¹ˆå°±åœ¨opencv-3.3.1/modules/features2d/testä¸‹å»æ‰¾test_detectors_invariance.impl.hppæ–‡ä»¶ï¼Œå°†å…¶å¤åˆ¶åˆ°opencv_contrib-3.3.1/modules/xfeatures2d/testç›®å½•ï¼Œç„¶åæ‰“å¼€test_rotation_and_scale_invariance.cppæ–‡ä»¶ï¼Œä¿®æ”¹#include "xxxx/test_detectors_invariance.impl.hpp"ä¸º#include "test_detectors_invariance.impl.hpp"å³å¯

å¦‚æœè§‰å¾—éš¾å¾—æ¯ä¸ªæ–‡ä»¶å»æ‰¾ï¼Œé‚£ä¹ˆå¹²è„†å°†ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶è¿‡å»ï¼Œä¹‹åå°±è¯¥å¯¹äºæŠ¥é”™æ–‡ä»¶çš„#includeä½ç½®å°±å¥½äº†ã€‚
```

---

### å®‰è£…DeepStream

```Shell
cd /opt/nvidia/deepstream/deepstream-6.0/
sudo ./install.sh
sudo ldconfig

# æŸ¥çœ‹å®‰è£…çš„ç‰ˆæœ¬
deepstream-app --version-all
```

#### å¯èƒ½çš„æŠ¥é”™

```Plain Text
1. å¦‚æœè¿è¡Œæ—¶æŠ¥é”™æç¤ºæ‰¾ä¸åˆ°ä¸€äº›åº“ï¼Œå¦‚libnvdsgst_meta.soï¼Œåˆ™éœ€è¦æŠŠdeepstream-6.0/libæ·»åŠ åˆ°ç³»ç»Ÿlibè·¯å¾„ä¸­ï¼Œå¦‚ä¸‹
sudo vim /etc/ld.so.conf
/opt/nvidia/deepstream/deepstream-6.0/lib/       //åœ¨æ–‡æœ¬åè¾¹æ·»åŠ è¯¥è·¯å¾„
sudo ldconfig    //æ‰§è¡Œldconfigç«‹å³ç”Ÿæ•ˆ

2. ä½¿ç”¨è¿™ä¸ªshellå‘½ä»¤æ¥æµ‹è¯• deepstream-app -c source30_1080p_dec_infer-resnet_tiled_display_int8.txt
å¦‚æœæŠ¥é”™ï¼š
** ERROR: <create_multi_source_bin:714>: Failed to create element 'src_bin_muxer'
** ERROR: <create_multi_source_bin:777>: create_multi_source_bin failed
** ERROR: <create_pipeline:1045>: create_pipeline failed
** ERROR: <main:632>: Failed to create pipeline
Quitting
App run failed


åˆ™æ˜¯å› ä¸ºgstreamerç¼“å­˜é—®é¢˜ï¼Œè¿è¡Œä¸‹è¾¹æŒ‡ä»¤åˆ é™¤å³å¯ï¼Œè¿è¡ŒæˆåŠŸåï¼Œä¼šæ˜¾ç¤ºæ£€æµ‹ç”»é¢ã€‚

rm ${HOME}/.cache/gstreamer-1.0/registry.*


å¦‚æœæ˜¯åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œæ²¡æœ‰æ˜¾ç¤ºç•Œé¢çš„è¯ä¼šæŠ¥é”™å¦‚ä¸‹
No EGL DisplayÂ 
nvbufsurftransform: Could not get EGL display connection
éœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼Œå¦‚ä¸‹
vim ~/.bashrc
#æ‰“å¼€ååœ¨æœ€åè¾¹åŠ ä¸‹è¾¹è¯­å¥
unset DISPLAY
export DISPLAY=:0 
#æˆ–è€… export DISPLAY=:1
 
#ä¿å­˜é€€å‡º
source ~/.bashrc
rm ${HOME}/.cache/gstreamer-1.0/registry.*
 
#ç„¶åå†è¿è¡Œ
deepstream-app -c source30_1080p_dec_infer-resnet_tiled_display_int8.txt
```

